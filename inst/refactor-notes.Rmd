---
title: "Refactor Notes"
author: "Development Team"
date: "`r Sys.Date()`"
output: html_document
---

# 
Consider following tables `orders`, `order_items`, `products`, `customers` connected with join keys 
following sql convention `{child}.{parent-singular}_id = {parent}.id`, for example 
`orders.customer_id = customers.id`. `teal.data` setup would look like this:

```{r}
library(teal.data)
data <- within(teal_data(), {
  customers <- tibble::tribble(
    ~id, ~name, ~age, ~country,
    1, "Alice Johnson", 30, "USA",
    2, "Bob Smith", 25, "Canada",
    3, "Charlie Brown", 35, "UK",
    4, "David Wilson", 28, "Australia",
    5, "Emma Davis", 32, "USA",
    6, "Frank Miller", 27, "Canada",
    7, "Grace Taylor", 29, "UK",
    8, "Henry Clark", 33, "Australia",
    9, "Isabella Martinez", 26, "USA",
    10, "Jack Thompson", 31, "Canada"
  )

  orders <- tibble::tribble(
    ~id, ~customer_id, ~order_date, ~total_amount,
    101, 1, as.Date("2024-01-15"), 250.00,
    102, 1, as.Date("2024-02-01"), 150.00,
    103, 2, as.Date("2024-02-10"), 125.00,
    104, 3, as.Date("2024-02-15"), 200.00,
    105, 4, as.Date("2024-02-20"), 175.00,
    106, 5, as.Date("2024-03-01"), 300.00,
    107, 6, as.Date("2024-03-05"), 50.00,
    108, 7, as.Date("2024-03-10"), 225.00,
    109, 8, as.Date("2024-03-12"), 100.00,
    110, 9, as.Date("2024-03-15"), 275.00,
    111, 10, as.Date("2024-03-18"), 125.00,
    112, 2, as.Date("2024-03-20"), 150.00
  )

  order_items <- tibble::tribble(
    ~id, ~order_id, ~product_id, ~quantity, ~unit_price, ~total_price,
    201, 101, 1, 2, 100.00, 200.00,
    202, 101, 2, 1, 50.00, 50.00,
    203, 102, 2, 3, 50.00, 150.00,
    204, 103, 2, 1, 50.00, 50.00,
    205, 103, 3, 1, 75.00, 75.00,
    206, 104, 1, 2, 100.00, 200.00,
    207, 105, 3, 2, 75.00, 150.00,
    208, 105, 2, 1, 50.00, 50.00,
    209, 106, 1, 3, 100.00, 300.00,
    210, 107, 2, 1, 50.00, 50.00,
    211, 108, 1, 1, 100.00, 100.00,
    212, 108, 3, 2, 75.00, 150.00,
    213, 109, 2, 2, 50.00, 100.00,
    214, 110, 1, 2, 100.00, 200.00,
    215, 110, 3, 1, 75.00, 75.00,
    216, 111, 2, 2, 50.00, 100.00,
    217, 111, 1, 1, 100.00, 100.00,
    218, 112, 3, 2, 75.00, 150.00
  )

  order_files <- tibble::tribble(
    ~id, ~order_id, ~file_name, ~file_type,
    301, 101, "invoice_101.pdf", "invoice",
    302, 102, "receipt_102.pdf", "receipt",
    303, 103, "invoice_103.pdf", "invoice",
    304, 104, "receipt_104.pdf", "receipt",
    305, 105, "invoice_105.pdf", "invoice",
    306, 106, "receipt_106.pdf", "receipt",
    307, 107, "invoice_107.pdf", "invoice",
    308, 108, "receipt_108.pdf", "receipt",
    309, 109, "invoice_109.pdf", "invoice",
    310, 110, "receipt_110.pdf", "receipt",
    311, 111, "invoice_111.pdf", "invoice",
    312, 112, "receipt_112.pdf", "receipt"
  )

  products <- tibble::tribble(
    ~id, ~name, ~price, ~category, ~stock_quantity,
    401, "Laptop Pro", 100.00, "Electronics", 15,
    402, "Wireless Mouse", 50.00, "Electronics", 50,
    403, "Office Chair", 75.00, "Furniture", 8
  )

  product_components <- tibble::tribble(
    ~id, ~product_id, ~component_name, ~component_type, ~quantity_required, ~cost,
    501, 401, "CPU", "Processor", 1, 25.00,
    502, 401, "RAM", "Memory", 2, 15.00,
    503, 401, "SSD", "Storage", 1, 20.00,
    504, 401, "Screen", "Display", 1, 30.00,
    505, 402, "Optical Sensor", "Sensor", 1, 8.00,
    506, 402, "Wireless Module", "Connectivity", 1, 12.00,
    507, 402, "Battery", "Power", 1, 5.00,
    508, 403, "Steel Frame", "Structure", 1, 35.00,
    509, 403, "Cushion", "Comfort", 1, 20.00,
    510, 403, "Wheels", "Mobility", 5, 3.00
  )
})

join_keys(data) <- join_keys(
  join_key("customers", keys = "id"),
  join_key("orders", keys = c("id")),
  join_key("products", keys = c("id")),
  join_key("product_components", keys = c("id")),
  # foreign keys
  join_key("customers", "orders", keys = c(id = "customer_id")),
  join_key("products", "order_items", keys = c(id = "product_id")),
  join_key("products", "product_components", keys = c(id = "product_id")),
  join_key("orders", "order_items", keys = c(id = "order_id"))
)

print(join_keys(data))
```

Imagine now a scenario of a `ggplot` where one wants to select `x`, `y`, `color`, `facet_rows`, 
`facet_cols`. Of course each input can come from different variables

```{r, eval=FALSE}
ggplot(
  data = ?,
  aes(
    x = !!sym(input$x), # orders.order_date
    y = !!sym(input$y), # order_items.total_price
    color = !!sym(input$color) # products.category
  )
) +
  geom_line() +
  facet_grid(
    vars(!!sym(input$facet_rows)) # customers.country
  )
```

In order to create above visualization datasets need to be merged as `aes` is related to single 
data object. Problem is solvable as `teal.data` has enough information to determine correct 
merge call based and selected variables and `join_keys` (describing relationships between datasets).

Using `dplyr` only we need to perform following merge operation given that following variables have 
been selected:

- x: `orders.order_date`
- y: `sum` of `order_items.order_items.total_price`
- color: `products.category`
- facet_rows: `customers.country`

```{r}
data_w_merged <- within(data, {
  library(dplyr)
  anl <- select(orders, id, customer_id, order_date) |>
    left_join(select(order_items, order_id, product_id, total_price), by = c(id = "order_id")) |>
    left_join(select(products, id, category), by = c(product_id = "id")) |>
    left_join(select(customers, id, country), by = c(customer_id = "id"))
}) 
```

Now `anl` can produce desired visualization

```{r}
# Create the visualization with merged data - sum moved to ggplot
data_w_plot <- within(data_w_merged, {
  library(ggplot2)

  # Create ggplot with sum calculation inside
  plot <- ggplot(
    data = anl,
    aes(
      x = order_date,
      y = total_price,
      color = category
    )
  ) +
    geom_line() +
    facet_grid(
      rows = vars(country),
      labeller = label_both
    )
  
  print(plot)
})

get_outputs(data_w_plot)[[1]]
```


# Handling ambiguous variables

